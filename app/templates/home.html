<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Patient Info Search + Chat</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #f8f9fa; }
    .col-score { text-align: left; } 

    .chat-box {
      height: 45vh; overflow-y: auto;
      background: #fff; border: 1px solid #e9ecef;
      border-radius: .5rem; padding: 1rem;
    }
    .msg {
      max-width: 75%; margin-bottom: .75rem;
      padding: .65rem .8rem; border-radius: .7rem; line-height: 1.35;
    }
    .msg-user { margin-left: auto; background: #0d6efd; color: #fff; }
    .msg-bot  { margin-right: auto; background: #f1f3f5; color: #212529; }

    .drag-scroll {
      cursor: grab;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      box-shadow: inset 0 -6px 6px -6px rgba(0,0,0,.08);
      padding: 0.5rem; 
    }
    .drag-scroll:active { cursor: grabbing; }

    th, td {
      vertical-align: middle;
      padding: 0.6rem 1rem; 
    }
    th.text-nowrap, td.text-nowrap { white-space: nowrap; }
    .wrap-col { white-space: normal; }
    .card { border-radius: .75rem; overflow: hidden; }
  </style>
</head>

<body>
  <div class="container py-4">
    <h2 class="mb-4">Patient Info Vector Search</h2>

    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="search-tab" data-bs-toggle="tab"
                data-bs-target="#searchPane" type="button" role="tab">Search</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="chat-tab" data-bs-toggle="tab"
                data-bs-target="#chatPane" type="button" role="tab">Chat</button>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="searchPane" role="tabpanel" aria-labelledby="search-tab">
        <form method="POST" class="row g-3 mb-4">
          <div class="col-md-10">
            <input type="text" name="query" class="form-control"
                   placeholder="Describe the patient (e.g. allergy, medication, etc.)"
                   value="{{ query_text }}" required>
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary w-100">Search</button>
          </div>
        </form>

        {% if error %}
          <div class="alert alert-danger">{{ error }}</div>
        {% endif %}

        {% if results %}
          <div class="card shadow-sm">
            <div class="card-header">Top Similar Results</div>

            <div class="table-responsive drag-scroll" id="resultsScroll">
              <table class="table table-striped table-sm align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    {% for col in columns %}
                      <th class="{% if col in ['Name','City','DOB','PostalCode','State','score'] %}text-nowrap{% endif %}">
                        {{ col }}
                      </th>
                    {% endfor %}
                  </tr>
                </thead>

                <tbody>
                  {% for row in results %}
                    <tr>
                      {% for col in columns %}
                        {% set val = row.get(col, '') %}

                        {% if col == 'score' %}
                          <td class="text-nowrap">{{ "%.6f"|format((val|float)) }}</td>

                        {% elif col in ['Name','City','DOB','PostalCode','State'] %}
                          <td class="text-nowrap">{{ (val|string).replace('\n',' ') }}</td>

                        {% elif col in ['Allergies','FamilyHistory','Medication','Street'] %}
                          <td class="wrap-col">
                            {{ (val|string).replace('\n',' ').replace(',', ',<br>')|safe }}
                          </td>

                        {% else %}
                          <td class="wrap-col">{{ (val|string).replace('\n',' ') }}</td>
                        {% endif %}
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        {% endif %}
      </div>

      <div class="tab-pane fade" id="chatPane" role="tabpanel" aria-labelledby="chat-tab">
        <div class="card shadow-sm">
          <div class="card-header">Patient Assistant Chat</div>
          <div class="card-body">
            <div id="chatMessages" class="chat-box mb-2"></div>
            <form onsubmit="return false;">
              <div class="d-flex gap-2">
                <input class="form-control" id="chatInput" placeholder="Ask about patients, cohorts, medicationsâ€¦" />
                <button class="btn btn-primary" id="sendBtn" type="button">Send</button>
                <button class="btn btn-outline-danger" id="clearBtn" type="button">Clear</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      const box = document.getElementById('resultsScroll');
      if (!box) return;
      let isDown = false, startX, scrollLeft;
      box.addEventListener('mousedown', (e) => {
        isDown = true;
        startX = e.pageX - box.getBoundingClientRect().left;
        scrollLeft = box.scrollLeft;
      });
      ['mouseleave','mouseup'].forEach(ev =>
        box.addEventListener(ev, () => (isDown = false))
      );
      box.addEventListener('mousemove', (e) => {
        if (!isDown) return;
        e.preventDefault();
        const x = e.pageX - box.getBoundingClientRect().left;
        box.scrollLeft = scrollLeft - (x - startX);
      });
    })();
  </script>

<script>
  const chatBox  = document.getElementById('chatMessages');
  const input    = document.getElementById('chatInput');
  const sendBtn  = document.getElementById('sendBtn');
  const clearBtn = document.getElementById('clearBtn');

  function addMsg(text, who='bot') {
    const div = document.createElement('div');
    div.className = 'msg ' + (who === 'user' ? 'msg-user' : 'msg-bot');
    div.innerHTML = text.replace(/\n/g, '<br>');
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendMessage() {
    const q = (input.value || '').trim();
    if (!q) return;
    addMsg(q, 'user');
    input.value = '';
    addMsg('Thinking...', 'bot');
    try {
      const resp = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ message: q })
      });
      const data = await resp.json();
      chatBox.lastChild.remove();
      addMsg(data.reply || '(no response)', 'bot');
    } catch (err) {
      chatBox.lastChild.remove();
      addMsg(' Error: ' + err, 'bot');
    }
  }

  sendBtn.addEventListener('click', sendMessage);
  clearBtn.onclick = () => { chatBox.innerHTML = ''; };

  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();   
      sendMessage();
    }
  });
</script>

</body>
</html>
